sudo: false
cache:
  apt: true
language: php
matrix:
  include:
  - php: 5.6
    env: WP_TRAVISCI=travis:js
  - php: 5.6
    env: WP_TRAVISCI=travis:codecoverage
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit
  - php: 5.5
    env: WP_TRAVISCI=travis:phpunit
  - php: 5.4
    env: WP_TRAVISCI=travis:phpunit
  - php: 5.3
    env: WP_TRAVISCI=travis:phpunit
  - php: 5.2
    env: WP_TRAVISCI=travis:phpunit
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit WP_TRAVISCI_BUILD=true
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit WP_TRAVISCI_OBJECT_CACHE=memcache
    services: memcached
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit WP_TRAVISCI_OBJECT_CACHE=apc
    services: memcached
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit WP_TRAVISCI_OBJECT_CACHE=batcache
    services: memcached
  - php: 5.6
    env: WP_TRAVISCI=travis:phpunit WP_TRAVISCI_OBJECT_CACHE=redis
    services: redis-server
  - php: hhvm
    env: WP_TRAVISCI=travis:phpunit
  - php: nightly
    env: WP_TRAVISCI=travis:phpunit
  allow_failures:
  - php: hhvm
  - php: nightly
  fast_finish: true
cache:
  directories:
  - node_modules
before_install:
- WP_CORE_DIR=/tmp/wordpress/
- |
  if [[ "$WP_TRAVISCI" == "travis:phpunit" ]]; then
      mysql -e "CREATE DATABASE wordpress_tests;" -uroot
      cp wp-tests-config-sample.php wp-tests-config.php
      sed -i "s/youremptytestdbnamehere/wordpress_tests/" wp-tests-config.php
      sed -i "s/yourusernamehere/travis/" wp-tests-config.php
      sed -i "s/yourpasswordhere//" wp-tests-config.php
      svn checkout https://plugins.svn.wordpress.org/wordpress-importer/trunk tests/phpunit/data/plugins/wordpress-importer
  fi
- |
  if [[ "$WP_TRAVISCI" == "travis:codecoverage" ]]; then
      mysql -e "CREATE DATABASE wordpress_tests;" -uroot
      cp wp-tests-config-sample.php wp-tests-config.php
      sed -i "s/youremptytestdbnamehere/wordpress_tests/" wp-tests-config.php
      sed -i "s/yourusernamehere/travis/" wp-tests-config.php
      sed -i "s/yourpasswordhere//" wp-tests-config.php
      svn checkout https://plugins.svn.wordpress.org/wordpress-importer/trunk tests/phpunit/data/plugins/wordpress-importer
  fi
- |
  if [[ "$WP_TRAVISCI_BUILD" == "true" ]]; then
      mysql -e "CREATE DATABASE wordpress_tests;" -uroot
      cp wp-tests-config-sample.php wp-tests-config.php
      sed -i "s/src/build/" wp-tests-config.php
      sed -i "s/youremptytestdbnamehere/wordpress_tests/" wp-tests-config.php
      sed -i "s/yourusernamehere/travis/" wp-tests-config.php
      sed -i "s/yourpasswordhere//" wp-tests-config.php
      svn checkout https://plugins.svn.wordpress.org/wordpress-importer/trunk tests/phpunit/data/plugins/wordpress-importer
  fi
before_script:
- |
  if [[ "$WP_TRAVISCI_OBJECT_CACHE" == "memcache" ]]; then
      echo "extension = memcache.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      wget https://plugins.svn.wordpress.org/memcached/trunk/object-cache.php --no-check-certificate
      mv object-cache.php src/wp-content/object-cache.php
  fi
- |
  if [[ "$WP_TRAVISCI_OBJECT_CACHE" == "apc" ]]; then
      echo "extension = apc.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      echo "apc.enabled=1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      echo "apc.enable_cli=1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      wget https://plugins.trac.wordpress.org/browser/apc/trunk/object-cache.php --no-check-certificate
      mv object-cache.php src/wp-content/object-cache.php
  fi
- |
  if [[ "$WP_TRAVISCI_OBJECT_CACHE" == "batcache" ]]; then
      echo "extension = apc.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      echo "apc.enabled=1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      echo "apc.enable_cli=1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      wget https://plugins.trac.wordpress.org/browser/batcache/trunk/advanced-cache.php --no-check-certificate
      mv advanced-cache.php src/wp-content/advanced-cache.php
  fi
- |
  if [[ "$WP_TRAVISCI_OBJECT_CACHE" == "redis" ]]; then
      echo "extension = redis.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
      wget https://plugins.trac.wordpress.org/browser/wp-redis/trunk/object-cache.php --no-check-certificate
      mv object-cache.php src/wp-content/object-cache.php
  fi
- node --version
- npm --version
- grunt --version
- npm install -g npm
- npm install -g grunt-cli
- npm install
- npm --version
- grunt --version
- |
  if [[ "$WP_TRAVISCI" == "travis:codecoverage" ]] ; then
    composer require codeclimate/php-test-reporter --dev
  fi
script: grunt $WP_TRAVISCI
after_script:
  # Push coverage off to Codecov
  # bash <(curl -s https://codecov.io/bash)
  # Push coverage off to Scrutinizer
  # wget https://scrutinizer-ci.com/ocular.phar
  # php ocular.phar code-coverage:upload --format=php-clover clover.xml
  - pwd
  - cd tests/phpunit/
  - pwd
  - |
    if [[ "$WP_TRAVISCI" == "travis:codecoverage" ]] ; then
      ../../vendor/bin/test-reporter --stdout > codeclimate.json
      "curl -X POST -d @codeclimate.json -H 'Content-Type: application/json' -H 'User-Agent: Code Climate (PHP Test Reporter v0.1.1)' https://codeclimate.com/test_reports"
    fi
notifications:
  slack:
    secure: lih3IWJqM6ppyK17lTElNOso2pgWgdi325QkYQiuluk2rOf7t5IuE+hHuO81TG8nC1ySQccbeNOoL+qQwMmb20ER5yHHndlh2Ml1i9LgL+RInstkqAtmU9uhAmvlS0n5L55aeGCjE3+IOLyNwCHxaC6xPdAl9uASN8hpQlqD4kg=
